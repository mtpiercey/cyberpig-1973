      SUBROUTINE UPDATE(IN,VEN)
      
      COMMON /INIT/ NR, NW, ND, NT7, NT8, NDAT, NS1, NS2
      COMMON /GEN/ ITOT, ISIZE, NOWT, NOWY, NDAYS, NRUNS, IATRIB(18), ATRIB(4)
      COMMON /HOUSE/ NH(6), N1, N2, N3, N4, N5, N6, NXTFAR, MX1, MX2, MX3, MX4
      COMMON /SKIP/ ISTOP4, ISTOP5, ISTOP6, ISTOP7, MAXSKP
      COMMON /SURVIV/ PW1, PW23, PSRT, PSFIN, PSOWS, PBORS, PBORS1, MDEAD(8), PSRT2
      COMMON /GAIN/ GW1, GW23, GSRT, GFIN1, GFIN2, GSOWM, GSOWL, SDP, SSOWM, SSOWL
      COMMON /BIRTH/ BRNM, BRNS, BMIN, BMAX, BWTM, BWTS, BWMIN, BWMAX, NOBRN
      COMMON /BRED/ LBREED, NBREED, IFAR(6, 5), IDB(30), KAGEW, LGTHW, NAGEM
      COMMON /BRED2/ DUM(3), GMIN
      COMMON /BRED3/ PTRM1, PTRM2, PTRM16
      COMMON /CLEAN/ NDPREV, NH4CLN, LOSSL, SWTLP, SSLP, KL4
      COMMON /CULL/ NGLTS, MXSRV, MXAGS, PCULG, PCULS, PSSR, PRGT, MXBOR
      COMMON /SALES/ MDSELL, WTS, NXTSAL

C CALLED FROM SUB. EVNTS, APPLY SKIP TESTS, SURVIVAL PROB., I.E.
C       GENERATE UPDATE OF ANIMALS IN FILES.  SUB. FAROW IS PART OF UPDATE.

      DIMENSION IN(3, 1), VEN(2, 1)

C BRANCH TO HOUSE SECTION 4,5,6,7, OR 8.
      IC = IATRIB(6)
      IF(IC-4) 1380, 4000, 5555
5555  IF(IC-6) 5000, 6000, 7777
7777  IF(IC-8) 7000, 8000, 1380


C GENERAL RETURN TO FILE ACCORDING TO IATRIB(6)
700   CALL FILEM(IN, VEN, IATRIB(6))
      RETURN

C BOAR UPDATING, DAY AT A TIME.
8000  IAT1 = IATRIB(1)
      IAT10 = IATRIB(10)
      K = IATRIB(3)
      IAT4 = IATRIB(4)
      IF(ATRIB(2) .LE. 0.0) ATRIB(2) = RNORM(GSOWM / 2.0, SSOWM, -5.0, 10.0)

C SORT FOR MAXIMUM AGE TO KEEP BOAR -MXBOR-
      IF(IAT1-MXBOR) 8005, 8002, 8002
8002  SKIP = NXTSAL - NOWT
      ATRIB(1) = ATRIB(1) + ATRIB(2) * SKIP
      CALL FILEM(IN, VEN, 9)
      RETURN
8005  IF(IAT10) 6081, 6081, 6082
6081  IF(RANUM(0) .GT. PBORS) GO TO 613
      GO TO 6083
6082  IF(RANUM(0) .GT. PBORS) GO TO 613
6083  IAT1 = IAT1 + 1
      IATRIB(1) = IAT1
      IATRIB(9) = IATRIB(9) + 1
      ATRIB(1) = ATRIB(1) + ATRIB(2)

C CHECK K SUB-CLASS FOR NEW STATUS
      IF(K .EQ. 1) GO TO 8011

C CONVERT DAILY SERVICES (10) TO 6 DAY PACKED TALLY IN (11).
      IAT11 = IATRIB(11)
      IATRIB(11) = MOD(IAT11 * 10 + IAT10, 1000000)
      IATRIB(10) = 0

C CONTINUE CHECKING
      IF (IAT1 .EQ. 195) GO TO 8011
      IF (IAT1 .EQ. 366) GO TO 8017

6085  IATRIB(4) = IAT4 + 1
      GO TO 700

8011  IF(IAT4 .GT. 29) GO TO 8013
      GO TO 6085
8013  IF(IAT1 .GT. 194) GO TO 8015
      GO TO 6085

C YOUNG BOAR, START TALLY 4 GAIN LIKE SOW/2, VARIANCE LIKE SOWS
8015  IATRIB(3) = 2
      IATRIB(4) = 1
      ATRIB(2) = RNORM(GSOWM / 2.0, SSOWM, -5.0, 10.0)
      GO TO 700

C MATURE BOAR, START TALLY 4, GAIN REDUCED TO ARBITRARY SMALL AMOUNT.
8017  IATRIB(3) = 3
      IATRIB(4) = 1
      ATRIB(2) = 0.001

      GO TO 700

C SOWS IN LAC. AND SUCKLING PIGS WK 1, WK 2-3, OR STARTING AGE.
C       HOLD SOWS ISKIP DOWN TO HER PIGS AGE CLASSES.

C   NH4CLN IS HELD=1 UNTIL WEANING BEGINS THEN SET =2
4000  IF(NH4CLN-1) 4001, 4002, 4001
4001  ISTOP4 = NOWT
      GO TO 4009
4002  IF(ISTOP4 - (NOWT + 6)) 4003, 4009, 4009
4003  ISTOP4 = NOWT + 6
4009  ISKIP = ISTOP4 - NOWT + 1
      IF(ISKIP .GT. MAXSKP) ISKIP = MAXSKP
      IAGE = IATRIB(1)
      LTAL = IATRIB(4)
      IF(IAGE .GT. 200) ISKPT = LTAL
      IF(IAGE .LE. 200) ISKPT = IAGE
      IF(ISKPT .LT. 8) ISKIP = 1
      IF(ISKIP .GT. 7) ISKIP = 7
      SKIP = ISKIP

C PIGS HERE, SOWS IN 4500.
      IF(IAGE .GT. 200) GO TO 4500

C BABY PIGS IN HOUSE 4.
      IF(IAGE-56) 4320, 4320, 5000
4320  BW = IATRIB(11)
      BRTHW = BW / 100.0
      IF(IAGE .LE. 7) GO TO 4007
      IF(IAGE .LE. 21) GO TO 4021

C PIGS AGE 22, UP TO 56 BUT NOT WEANED.
      P = PSRT ** SKIP
      IF(IAGE-22) 4201, 4202, 4201
4202  ATRIB(2) = RNORM(GSRT, SDP * GSRT, -5.0, 10.0)
4201  G = ATRIB(2) * SKIP
      GO TO 4050

C BABY PIGS 1, AND 2-3 WKS. ADJ. WT.
C DAILY SURV. PROB. ADJ=.0049*DEVIATION BIRTHWT, SPEER REF.
4021  IF(IAGE + ISKIP - 22) 4023, 4023, 4022
4022  ISKIP = 22 - IAGE
      SKIP = ISKIP
4023  P = (PW23 + (0.0049 * (BRTHW - BWTM))) ** SKIP
      IF(IAGE-8) 4029, 4027, 4029
4027  ATRIB(2) = RNORM(GW23, SDP * GW23, -0.5, 10.0)
4029  G = ATRIB(2) * SKIP
      GO TO 4050
4007  P = (PW1 + (0.0049 * (BRTHW - BWTM))) ** SKIP
      IF(ATRIB(2)) 4019, 4008, 4019
4008  ATRIB(2) = RNORM(GW1, SDP * SW1, -5.0, 10.0)
4019  G = ATRIB(2) * SKIP
4050  IF(RANUM(0) .GT. P) GO TO 613

C IF SURVIVED, FILE.
4051  IATRIB(1) = IATRIB(1) + ISKIP
      IATRIB(9) = IATRIB(9) + ISKIP
      ATRIB(1) = ATRIB(1) + G
      GO TO 700

C SOWS OF HOUSE 4 I.E. IN LACTATION WITH BABY PIGS
4500  IF(RANUM(0) .GT. PSOWS ** SKIP) GO TO 4613

C SOW WITH 1 PIG OR LESS MOVED VIA TERMINATION TO HOUSE 6
      IF(IATRIB(8) .GT. 1) GO TO 4515
      IATRIB(6) = 6
      GO TO 6355
4515  IATRIB(4) = LTAL + ISKIP
      G = ATRIB(2) * SKIP

C SURVIVES, FILE BACK TO HOUSE 4.
      GO TO 4051

C LACTATING SOW DIES, KILL SOW, CHECK ON BABY PIGS WELFARE.
4613  NPIGS = IATRIB(8)
      NUSOW = IATRIB(5)
      MDEAD(4) = MDEAD(4) + 1

C ADJUST LITTER COUNT (KL4) IN FARROWING HOUSE.
      KL4 = KL4 - 1

C FIND PIGS, .LT. 7 DAY DIE, 50 PERCENT LIVE AFTER 7 DAYS AGE.
4623  CALL FIND(NUSOW, 5, 4, 8, KKOL, IN, VEN)
      IF(KKOL .EQ. 0) RETURN

C MTP: NOT SURE WHY THIS LINE IS COMMENTED OUT
C     CALL REMOV(IN,VEN,KKOL)
      IF(IATRIB(1) .LE. 7) GO TO 4623
      IF(RANUM(0) .GT. 0.5) GO TO 4623
      IATRIB(8) = 0
      IATRIB(13) = 77
      CALL FILEM(IN, VEN, 4)
      GO TO 4623

C STARTING PIG= 22-56 DAYS, GROWING = 57-180
C NURSERY HOUSE PIGS
5000  ISKIP = ISTOP5 - NOWT + 1
      IF(ISKIP .GT. MAXSKP) ISKIP = MAXSKP
      IAGE = IATRIB(1)
      IF(IAGE .GT. 55) GO TO 5500

C PIGS ARE 22-56, ALLOWED TO SKIP TO 57 ONLY.
      IF(IAGE + ISKIP - 57) 5005, 5005, 5003
5003  ISKIP = 57 - IAGE
5005  IF(IAGE-22) 5006, 5006, 5007
5006  ATRIB(2) = RNORM(GW23, SDP * GW23, -5.0, 10.0)
5007  SKIP = ISKIP

C PIGS AGE 22, UP TO 56 BUT WEANED.
      P = PSRT2 ** SKIP
      RGAIN = ATRIB(2)

C TEST, ADJUST AND FILE VIA 7045
      GO TO 7045

C PIGS AGE 57-150
5500  IF(IAGE-149) 551, 5509, 5509
551   IF(IAGE-57) 5057, 5057, 5058
5057  ATRIB(2) = RNORM(GFIN1, GFIN1 * SDP, -5.0, 10.0)
5058  IF(IAGE-NAGEM) 552, 5509, 5509
552   IF(IAGE + ISKIP - NAGEM) 558, 558, 5070
5070  ISKIP = NAGEM - IAGE
      GO TO 558

C MOVE TO HOUSE 7 AND ADD ONE DAY TO ITS UPDATE.
C IF FINISHING HOUSE FULL, STAYS IATRIB(6)=5
C MOVING DECISION IS THEN IN SUB. MGT3. DAILY.
5509  IF(NH(4)-MX4) 5512, 5514, 5514
5512  IATRIB(6) = 7
5514  ISKIP = 1
558   SKIP = ISKIP
      P = PSFIN ** SKIP
      RGAIN = ATRIB(2)

C TEST, ADJUST AND FILE VIA 7045
      GO TO 7045


C SOW AND GILT OF MAINTENANCE BUILDING NO. 6
6000  IAT1 = IATRIB(1)
      IF(IAT1-MXAGS) 6001, 6001, 6900

C AGE CAN BE SET ARTIFICALLY HIGH IN SUB. BREED FOR CULL FLAG.
C SOW OVER AGE SEND TO FILE 9 FOR SALE AS CULL.
6900  IF(IATRIB(3)-3) 6901, 6001, 6901
6901  ISKIP = NXTSAL - NOWT
      SKIP = ISKIP
      IATRIB(9) = IATRIB(9) + ISKIP
      IATRIB(1) = IATRIB(1) + ISKIP
      ATRIB(1) = ATRIB(1) + SKIP * RNORM(GSOWM, SSOWM, -5.0, 10.0)
      CALL FILEM(IN, VEN, 9)
      RETURN
6001  ISKIP = ISTOP6 - NOWT + 1
      IF(ISKIP .GT. MAXSKP) ISKIP = MAXSKP
      SKIP = ISKIP
      J = IATRIB(2)
      K = IATRIB(3)
      IAT10 = IATRIB(10)
      IAT4 = IATRIB(4)


C GO TO VALUE OF K.
      IF(K-2) 6100, 6200, 6300


C K=1 YOUNG AND OR ABNORMAL GILTS SET IN SUB. SELECT.
C       SUB. SELECT PUTS GILTS INTO HOUSE 6 BEFORE 210 DAYS OF AGE

6100  IF(IATRIB(10) .EQ. 99) GO TO 6204
      IF(IAT1 + ISKIP .GT. 209) ISKIP = 210 - IAT1
      IF(IAT1 .NE. 210) GO TO 6204
      IATRIB(3) = 2
      IATRIB(4) = 0
      IATRIB(10) = RNORM(ESTM, ESTS, EMIN, EMAX) + 0.5
      GO TO 6204


C K=2, OVULATING SOWS AND GILTS
6200  IF(IAT4 - IAT10) 6202, 6201, 6201

C ISKIP=1, PUTS SOW IN HEAT, SENDS TO SUB. BREED.
6201  ISKIP = 1
      CALL BREED(IN, VEN)

C TEST FOR K=2,3 AND CONTINUE ITS UPDATE.
      IF(IATRIB(3)-3) 6204, 6300, 1380
6202  IF(IAT4 + ISKIP .GT. IAT10) ISKIP = IAT10 - IAT4
6204  SKIP = ISKIP
      IF(RANUM(0) .GT. PSOWS ** SKIP) GO TO 613
      IATRIB(1) = IATI1 + ISKIP

C IATRIB(4) CAN BE ZERO FROM SUB. BREED.
      IATRIB(4) = IATRIB(4) + ISKIP
      IATRIB(9) = IATRIB(9) + ISKIP
      ATRIB(1) = ATRIB(1) + ATRIB(2) * SKIP
      CALL FILEM(IN, VEN, 6)
      RETURN


C SOW IN GESTATION, K=3, APPLY PROBABILITY OF SURVIVAL, PREMATURE
6300  IA4 = IATRIB(4)
      IF(IA4 + ISKIP .GT. GMIN - 2) GO TO 6305
      IF(IA4 .GE. 8) GO TO 6325
      IF(IA4 - 7) 6301, 6302, 1380
C
C GESTATION SOWS.
C 

C FIRST WEEK PREGNANCY- SURVIV NOPRETERM, SURVIV PRETERM
6301  IF(ISKIP .GT. 7 - IA4) ISKIP = 7 - IA4
6302  SKIP = ISKIP
      RN = RANUM(0)
      P1 = (PSOWS * (1.0 - PTRM1)) ** SKIP
      IF(RN .LE. P1) GO TO 6350
      P2 = (PSOWS * PTRM1) ** SKIP
6326  IF(RN .LE. P1 + P2) GO TO 6355
      GO TO 613

C NO PRETERM
6350  IATRIB(1) = IATRIB(1) + ISKIP
      IATRIB(4) = IATRIB(4) + ISKIP
      IATRIB(9) = IATRIB(9) + ISKIP
      ATRIB(1) =  ATRIB(1) + ATRIB(2) * SKIP

C FILE SOWS BACK IN HOUSE 6
      GO TO 700

C TERMINATION.
6355  IATRIB(3) = 2

C SET TO HEAT IN TRUNCATED 1/3 LENGTH ESTRUS-1
      ISKIP = 1
      SKIP = 1.0
      IATRIB(4) = IATRIB(10) / 3 * 2 + 1
      IATRIB(8) = 0
      IATRIB(11) = 0
      GO TO 6350

C FOR 8-107 DAYS OF GESTATION.
6325  RN = RANUM(0)
      P1 = (PSOWS * (1.0 - PTRM2)) ** SKIP
      IF(RN .LT. P1) GO TO 6350
      P2 = (PSOWS * PTRM2) ** SKIP
      GO TO 6326

C 108 DAYS TO FULL TERM AT LENGTH=IATRIB(11)
6305  IA11 = IATRIB(11)

C BRANCH TO SUBROUTINE FAROW
      IF(IA11 - IA4 .LE. 1) GO TO 6099
      IF(ISKIP .GE. IA11 - IA4) ISKIP = IA11 - IA4 - 1
      SKIP = ISKIP

C NOT FARROWING
      RN = RANUM(0)
      P1 = (PSOWS * (1.0 - PTRM16)) ** SKIP
      IF(RN .LE. P1) GO TO 6350
      P2 = (PSOWS * PTRM16) ** SKIP
      GO TO 6326

C RETURNED OPEN AND SENT TO STATEMENT 6355.
6099  CALL FAROW(IN, VEN)
      IF(IATRIB(1) .EQ. 0) RETURN
      ISKIP = 1
      SKIP = 1.0
      IF(NH4CLN-1) 6355, 6665, 6355
6665  IF(MX1-KL4) 6355, 6666, 6666
6666  RETURN

C
C FINISHING HOUSE PIGS
C

C       MAXSKP=14 DEFAULT, ISTOP7 FIRST SET TO NDAY THEN IN SUB. SELL
7000  ISKIP = ISTOP7 - NOWT + 1
      IF(ISKIP .GT. MAXSKP) ISKIP = MAXSKP
      IF(IATRIB(1)-56) 7020, 7040, 7040
7020  ISKI = 56 - IATRIB(1)
      IF(ISKI-ISKIP) 7021, 7023, 7023
7021  ISKIP = ISKI
7023  SKIP = ISKIP
      RGAIN = ATRIB(2)
      P = PSRT ** SKIP
      GO TO 7045
7040  IF(IATRIB(1)-150) 7430, 7041, 7041
7430  IF(IATRIB(1)-56) 7431, 7431, 7433
7431  ATRIB(2) = RNORM(GFIN1, GFIN1 * SDP, -5.0, 10.0)
7433  RGAIN = ATRIB(2)
      IF(IATRIB(1) + ISKIP - 150) 7438, 7437, 7437
7437  ISKIP = 150 - IATRIB(1)
7438  SKIP = ISKIP
      P = PSFIN ** SKIP
      GO TO 7045
7041  IF(IATRIB(1)-150) 7042, 7042, 7043
7042  ATRIB(2) = RNORM(GFIN2, GFIN2 * SDP, -5.0, 10.0)
7043  RGAIN = ATRIB(2)
      SKIP = ISKIP
      P = PSFIN ** SKIP
7045  IF(RANUM(0) .GT. P) GO TO 613
      IATRIB(1) = IATRIB(1) + ISKIP
      IATRIB(9) = IATRIB(9) + ISKIP

C GAIN ADDED.
      ATRIB(1) = ATRIB(1) + RGAIN * SKIP

C FINISHED WITH ONE PIG FROM FINISHING HOUSE.
      CALL FILEM(IN, VEN, IATRIB(6))
      RETURN

C DEAD TALLY.
613   IAB = IATRIB(6)
      MDEAD(IAB) = MDEAD(IAB) + 1
      RETURN

C ERROR AND FINISHED WRITES.
1380  WRITE(ND, 1378) NOWT, KOL, (IATRIB(M), M = 1,15)
1378  FORMAT(' ERROR UPDATE, NOWT='I5' ,KOL='I5' ,IATRIB()='/10X,15I6)

      RETURN
      END